(function(){var b,c,d,a=function(e,f){return function(){return e.apply(f,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:[],init:function(e){this._connection=e;this._muc_handler=null;Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner");Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin");Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user");return Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(e,f,j,i,m,n){var g,k,l,h=this;k=this.test_append_nick(e,f);g=$pres({from:this._connection.jid,to:k}).c("x",{xmlns:Strophe.NS.MUC});if(n!=null){g.cnode(Strophe.xmlElement("password",[],n))}if(this._muc_handler==null){this._muc_handler=this._connection.addHandler(function(p){var y,z,q,o,r,w,s,u,t,v;y=p.getAttribute("from");r=y.split("/")[0];if(!h.rooms[r]){return true}e=h.rooms[r];q={};if(p.nodeName==="message"){q=e._message_handlers}else{if(p.nodeName==="presence"){u=p.getElementsByTagName("x");if(u.length>0){for(t=0,v=u.length;t<v;t++){w=u[t];s=w.getAttribute("xmlns");if(s&&s.match(Strophe.NS.MUC)){q=e._presence_handlers;break}}}}}for(o in q){z=q[o];if(!z(p,e)){delete q[o]}}return true})}if((l=this.rooms)[e]==null){l[e]=new d(this,e,f,n)}if(i){this.rooms[e].addHandler("presence",i)}if(j){this.rooms[e].addHandler("message",j)}if(m){this.rooms[e].addHandler("roster",m)}return this._connection.send(g)},leave:function(k,e,h,f){var g,i,j;delete this.rooms[k];if(this.rooms.length===0){this._connection.deleteHandler(this._muc_handler);this._muc_handler=null}j=this.test_append_nick(k,e);i=this._connection.getUniqueId();g=$pres({type:"unavailable",id:i,from:this._connection.jid,to:j});if(f!=null){g.c("status",f)}if(h!=null){this._connection.addHandler(h,null,"presence",null,i)}this._connection.send(g);return i},message:function(e,h,m,f,j){var i,g,l,k;k=this.test_append_nick(e,h);j=j||(h!=null?"chat":"groupchat");g=this._connection.getUniqueId();i=$msg({to:k,from:this._connection.jid,type:j,id:g}).c("body",{xmlns:Strophe.NS.CLIENT}).t(m);i.up();if(f!=null){i.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).h(f);if(i.node.childNodes.length===0){l=i.node.parentNode;i.up().up();i.node.removeChild(l)}else{i.up().up()}}i.c("x",{xmlns:"jabber:x:event"}).c("composing");this._connection.send(i);return g},groupchat:function(g,e,f){return this.message(g,null,e,f)},invite:function(i,f,h){var g,e;e=this._connection.getUniqueId();g=$msg({from:this._connection.jid,to:i,id:e}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:f});if(h!=null){g.c("reason",h)}this._connection.send(g);return e},directInvite:function(k,h,j,f){var e,i,g;g=this._connection.getUniqueId();e={xmlns:"jabber:x:conference",jid:k};if(j!=null){e.reason=j}if(f!=null){e.password=f}i=$msg({from:this._connection.jid,to:h,id:g}).c("x",e);this._connection.send(i);return g},queryOccupants:function(i,e,g){var f,h;f={xmlns:Strophe.NS.DISCO_ITEMS};h=$iq({from:this._connection.jid,to:i,type:"get"}).c("query",f);return this._connection.sendIQ(h,e,g)},configure:function(g,f){var e,i,h;e=$iq({to:g,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});h=e.tree();i=this._connection.sendIQ(h);if(f!=null){this._connection.addHandler(function(j){f(j);return false},Strophe.NS.MUC_OWNER,"iq",null,i)}return i},cancelConfigure:function(f){var e,g;e=$iq({to:f,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"});g=e.tree();return this._connection.sendIQ(g)},saveConfiguration:function(j,i){var g,f,k,h,e;f=$iq({to:j,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});for(h=0,e=i.length;h<e;h++){g=i[h];f.cnode(g).up()}k=f.tree();return this._connection.sendIQ(k)},createInstantRoom:function(f){var e;e=$iq({to:f,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});return this._connection.sendIQ(e.tree())},setTopic:function(f,e){var g;g=$msg({to:f,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(e);return this._connection.send(g.tree())},_modifyPrivilege:function(j,g,i,e,f){var h;h=$iq({to:j,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(g.node);if(i!=null){h.c("reason",i)}return this._connection.sendIQ(h.tree(),e,f)},modifyRole:function(j,e,k,i,f,h){var g;g=$build("item",{nick:e,role:k});return this._modifyPrivilege(j,g,i,f,h)},kick:function(i,e,h,f,g){return this.modifyRole(i,e,"none",h,f,g)},voice:function(i,e,h,f,g){return this.modifyRole(i,e,"participant",h,f,g)},mute:function(i,e,h,f,g){return this.modifyRole(i,e,"visitor",h,f,g)},op:function(i,e,h,f,g){return this.modifyRole(i,e,"moderator",h,f,g)},deop:function(i,e,h,f,g){return this.modifyRole(i,e,"participant",h,f,g)},modifyAffiliation:function(k,f,g,j,e,i){var h;h=$build("item",{jid:f,affiliation:g});return this._modifyPrivilege(k,h,j,e,i)},ban:function(i,f,h,e,g){return this.modifyAffiliation(i,f,"outcast",h,e,g)},member:function(i,f,h,e,g){return this.modifyAffiliation(i,f,"member",h,e,g)},revoke:function(i,f,h,e,g){return this.modifyAffiliation(i,f,"none",h,e,g)},owner:function(i,f,h,e,g){return this.modifyAffiliation(i,f,"owner",h,e,g)},admin:function(i,f,h,e,g){return this.modifyAffiliation(i,f,"admin",h,e,g)},changeNick:function(h,e){var f,g;g=this.test_append_nick(h,e);f=$pres({from:this._connection.jid,to:g,id:this._connection.getUniqueId()});return this._connection.send(f.tree())},setStatus:function(j,g,f,e){var h,i;i=this.test_append_nick(j,g);h=$pres({from:this._connection.jid,to:i});if(f!=null){h.c("show",f).up()}if(e!=null){h.c("status",e)}return this._connection.send(h.tree())},listRooms:function(g,e){var f;f=$iq({to:g,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS});return this._connection.sendIQ(f,e)},test_append_nick:function(f,e){return f+(e!=null?"/"+(Strophe.escapeNode(e)):"")}});d=(function(){e.prototype.roster={};e.prototype._message_handlers={};e.prototype._presence_handlers={};e.prototype._roster_handlers={};e.prototype._handler_ids=0;function e(g,i,f,h){this.client=g;this.name=i;this.nick=f;this.password=h;this._roomRosterHandler=a(this._roomRosterHandler,this);this._addOccupant=a(this._addOccupant,this);if(g.muc){this.client=g.muc}this.name=Strophe.getBareJidFromJid(i);this.client.rooms[this.name]=this;this.addHandler("presence",this._roomRosterHandler)}e.prototype.join=function(f,g){if(!this.client.rooms[this.name]){return this.client.join(this.name,this.nick,f,g,this.password)}};e.prototype.leave=function(f,g){this.client.leave(this.name,this.nick,f,g);return delete this.client.rooms[this.name]};e.prototype.message=function(f,h,i,g){return this.client.message(this.name,f,h,i,g)};e.prototype.groupchat=function(f,g){return this.client.groupchat(this.name,f,g)};e.prototype.invite=function(f,g){return this.client.invite(this.name,f,g)};e.prototype.directInvite=function(f,g){return this.client.directInvite(this.name,f,g,this.password)};e.prototype.configure=function(f){return this.client.configure(this.name,f)};e.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)};e.prototype.saveConfiguration=function(f){return this.client.saveConfiguration(this.name,f)};e.prototype.queryOccupants=function(f,g){return this.client.queryOccupants(this.name,f,g)};e.prototype.setTopic=function(f){return this.client.setTopic(this.name,f)};e.prototype.modifyRole=function(f,j,i,g,h){return this.client.modifyRole(this.name,f,j,i,g,h)};e.prototype.kick=function(f,i,g,h){return this.client.kick(this.name,f,i,g,h)};e.prototype.voice=function(f,i,g,h){return this.client.voice(this.name,f,i,g,h)};e.prototype.mute=function(f,i,g,h){return this.client.mute(this.name,f,i,g,h)};e.prototype.op=function(f,i,g,h){return this.client.op(this.name,f,i,g,h)};e.prototype.deop=function(f,i,g,h){return this.client.deop(this.name,f,i,g,h)};e.prototype.modifyAffiliation=function(g,h,j,f,i){return this.client.modifyAffiliation(this.name,g,h,j,f,i)};e.prototype.ban=function(g,i,f,h){return this.client.ban(this.name,g,i,f,h)};e.prototype.member=function(g,i,f,h){return this.client.member(this.name,g,i,f,h)};e.prototype.revoke=function(g,i,f,h){return this.client.revoke(this.name,g,i,f,h)};e.prototype.owner=function(g,i,f,h){return this.client.owner(this.name,g,i,f,h)};e.prototype.admin=function(g,i,f,h){return this.client.admin(this.name,g,i,f,h)};e.prototype.changeNick=function(f){this.nick=f;return this.client.changeNick(this.name,f)};e.prototype.setStatus=function(g,f){return this.client.setStatus(this.name,this.nick,g,f)};e.prototype.addHandler=function(g,f){var h;h=this._handler_ids++;switch(g){case"presence":this._presence_handlers[h]=f;break;case"message":this._message_handlers[h]=f;break;case"roster":this._roster_handlers[h]=f;break;default:this._handler_ids--;return null}return h};e.prototype.removeHandler=function(f){delete this._presence_handlers[f];delete this._message_handlers[f];return delete this._roster_handlers[f]};e.prototype._addOccupant=function(g){var f;f=new b(g,this);this.roster[f.nick]=f;return f};e.prototype._roomRosterHandler=function(k){var j,h,l,g,f,i;j=e._parsePresence(k);f=j.nick;g=j.newnick||null;switch(j.type){case"error":return;case"unavailable":if(g){j.nick=g;if(this.roster[f]&&this.roster[g]){this.roster[f].update(this.roster[g]);this.roster[g]=this.roster[f]}if(this.roster[f]&&!this.roster[g]){this.roster[g]=this.roster[f].update(j)}}delete this.roster[f];break;default:if(this.roster[f]){this.roster[f].update(j)}else{this._addOccupant(j)}}i=this._roster_handlers;for(l in i){h=i[l];if(!h(this.roster,this)){delete this._roster_handlers[l]}}return true};e._parsePresence=function(r){var u,t,p,s,o,n,v,h,q,m,l,k,j,i,g,f;s={};u=r.attributes;s.nick=Strophe.getResourceFromJid(u.from.textContent);s.type=((q=u.type)!=null?q.textContent:void 0)||null;s.states=[];m=r.childNodes;for(o=0,v=m.length;o<v;o++){t=m[o];switch(t.nodeName){case"status":s.status=t.textContent||null;break;case"show":s.show=t.textContent||null;break;case"x":u=t.attributes;if(((l=u.xmlns)!=null?l.textContent:void 0)===Strophe.NS.MUC_USER){k=t.childNodes;for(n=0,h=k.length;n<h;n++){p=k[n];switch(p.nodeName){case"item":u=p.attributes;s.affiliation=((j=u.affiliation)!=null?j.textContent:void 0)||null;s.role=((i=u.role)!=null?i.textContent:void 0)||null;s.jid=((g=u.jid)!=null?g.textContent:void 0)||null;s.newnick=((f=u.nick)!=null?f.textContent:void 0)||null;break;case"status":if(p.attributes.code){s.states.push(p.attributes.code.textContent)}}}}}}return s};return e})();c=(function(){function e(f){this.parse=a(this.parse,this);if(f!=null){this.parse(f)}}e.prototype.parse=function(s){var m,r,h,q,n,o,k,j,i,p,g,f,l;o=s.getElementsByTagName("query")[0].childNodes;this.identities=[];this.features=[];this.x=[];for(k=0,p=o.length;k<p;k++){h=o[k];r=h.attributes;switch(h.nodeName){case"identity":n={};for(j=0,g=r.length;j<g;j++){m=r[j];n[m.name]=m.textContent}this.identities.push(n);break;case"feature":this.features.push(r["var"].textContent);break;case"x":r=h.childNodes[0].attributes;if((!r["var"].textContent==="FORM_TYPE")||(!r.type.textContent==="hidden")){break}l=h.childNodes;for(i=0,f=l.length;i<f;i++){q=l[i];if(!(!q.attributes.type)){continue}r=q.attributes;this.x.push({"var":r["var"].textContent,label:r.label.textContent||"",value:q.firstChild.textContent||""})}}}return{identities:this.identities,features:this.features,x:this.x}};return e})();b=(function(){function e(f,g){this.room=g;this.update=a(this.update,this);this.admin=a(this.admin,this);this.owner=a(this.owner,this);this.revoke=a(this.revoke,this);this.member=a(this.member,this);this.ban=a(this.ban,this);this.modifyAffiliation=a(this.modifyAffiliation,this);this.deop=a(this.deop,this);this.op=a(this.op,this);this.mute=a(this.mute,this);this.voice=a(this.voice,this);this.kick=a(this.kick,this);this.modifyRole=a(this.modifyRole,this);this.update(f)}e.prototype.modifyRole=function(i,h,f,g){return this.room.modifyRole(this.nick,i,h,f,g)};e.prototype.kick=function(h,f,g){return this.room.kick(this.nick,h,f,g)};e.prototype.voice=function(h,f,g){return this.room.voice(this.nick,h,f,g)};e.prototype.mute=function(h,f,g){return this.room.mute(this.nick,h,f,g)};e.prototype.op=function(h,f,g){return this.room.op(this.nick,h,f,g)};e.prototype.deop=function(h,f,g){return this.room.deop(this.nick,h,f,g)};e.prototype.modifyAffiliation=function(g,i,f,h){return this.room.modifyAffiliation(this.jid,g,i,f,h)};e.prototype.ban=function(h,f,g){return this.room.ban(this.jid,h,f,g)};e.prototype.member=function(h,f,g){return this.room.member(this.jid,h,f,g)};e.prototype.revoke=function(h,f,g){return this.room.revoke(this.jid,h,f,g)};e.prototype.owner=function(h,f,g){return this.room.owner(this.jid,h,f,g)};e.prototype.admin=function(h,f,g){return this.room.admin(this.jid,h,f,g)};e.prototype.update=function(f){this.nick=f.nick||null;this.affiliation=f.affiliation||null;this.role=f.role||null;this.jid=f.jid||null;this.status=f.status||null;this.show=f.show||null;return this};return e})()}).call(this);